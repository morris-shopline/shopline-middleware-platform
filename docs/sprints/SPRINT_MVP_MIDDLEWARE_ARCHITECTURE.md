# Sprint: MVP 中台架構實施計劃

**目標**: 建立中台架構，實現前後端分離，完成 Shopline 完整授權流程  
**預計時間**: 2-3 週 (10-13 天)  
**狀態**: 準備開始  
**建立日期**: 2025-01-27

---

## 🎯 MVP 目標

### 核心功能
1. **Admin 首頁**
   - Event 監測 (即時顯示新事件)
   - Connector 管理 (目前只有 Shopline)
   - 測試環境可手動觸發測試事件

2. **Shopline Connector**
   - 初次授權流程 (OAuth 2.0)
   - 授權完成頁 (自動導回機制)
   - Token 管理 (顯示/Refresh/撤銷)
   - Webhook 管理 (訂閱/檢視/測試)
   - API 測試區塊 (商家/商品/訂單)

3. **Event 流轉機制**
   - Webhook 接收 → PostgreSQL 儲存
   - Redis Queue 處理 → 即時推播前端
   - 測試 API 發布事件 (開發環境)

4. **Token 管理**
   - PostgreSQL 永久儲存
   - localStorage 快速存取
   - 自動 Refresh 機制 (後續)

---

## 🏗️ 技術架構

### 整體架構圖

```
┌────────────────────────────────────────────┐
│                  Frontend (Vercel)        │
│  ┌──────────────┐  ┌──────────────────┐   │
│  │ Admin Home   │  │ Shopline Connector│   │
│  │ - Event List │  │ - 授權/撤銷/Refresh │   │
│  │ - Connector  │  │ - Webhook 管理    │   │
│  │   狀態總覽   │  │ - API 測試區塊    │   │
│  └──────────────┘  └──────────────────┘   │
└────────────────────────────────────────────┘
                │          ↑
                │          │ OAuth Redirect
                ▼          │
┌────────────────────────────────────────────┐
│              Backend (Render)              │
│────────────────────────────────────────────│
│   Fastify App (API Gateway)                │
│   ├─ /auth/shopline (OAuth callback)       │
│   ├─ /webhook/shopline (事件入口)          │
│   ├─ /events (提供前端查事件)              │
│   ├─ /connectors/shopline (API Proxy)      │
│────────────────────────────────────────────│
│   BullMQ Workers (Redis)                   │
│   ├─ eventProcessor                        │
│   ├─ apiTestPublisher                      │
│────────────────────────────────────────────│
│   Services Layer                           │
│   ├─ shopline.service.ts                   │
│   ├─ event.service.ts                      │
│   ├─ token.service.ts                      │
│────────────────────────────────────────────│
│   Database (PostgreSQL)                    │
│   ├─ tokens                                │
│   ├─ events                                │
│   ├─ webhooks                              │
│   ├─ connectors                            │
│────────────────────────────────────────────│
│   Queue (Redis Cloud)                      │
│   ├─ eventQueue                            │
│   ├─ apiTestQueue                          │
└────────────────────────────────────────────┘
```

### 技術選型

| 模組 | 技術 | 理由 |
|------|------|------|
| **Backend Framework** | Fastify + TypeScript | 高速 + JSON Schema 驗證方便 |
| **Queue** | BullMQ + Redis Cloud | 處理 webhook 背景任務 |
| **Database** | PostgreSQL + Prisma ORM | 型別安全、開發快 |
| **Frontend** | Next.js + SWR | 快速建立 admin UI |
| **Auth** | 自建 JWT + Refresh | Shopline OAuth callback 後發自己的 JWT |
| **Event 即時性** | SSE | Admin 首頁可即時看到新事件 |
| **Deployment** | Frontend on Vercel / Backend on Render | 分離部署 |

---

## 📅 詳細實施時程

### Phase 1: 專案結構重組 (2-3 天)

#### Day 1: 專案初始化
**時間**: 8 小時  
**負責人**: 全體團隊  
**風險等級**: 低

**上午 (4 小時)**:
- [ ] 建立新的專案目錄結構
  - [ ] `frontend/` (Next.js 專案)
  - [ ] `backend/` (Fastify 專案)
  - [ ] `shared/` (共用類型定義)
- [ ] 設定 TypeScript 配置
- [ ] 建立 Git 分支和 CI/CD 流程
- [ ] 設定開發環境和工具

**下午 (4 小時)**:
- [ ] 建立 Render 後端專案
- [ ] 建立 Vercel 前端專案
- [ ] 設定 PostgreSQL 資料庫
- [ ] 設定 Redis Cloud
- [ ] 配置環境變數

**交付物**:
- [ ] 新的專案結構
- [ ] 開發環境設定完成
- [ ] 雲端服務配置完成

#### Day 2: 後端基礎架構
**時間**: 8 小時  
**負責人**: 後端開發者  
**風險等級**: 中

**上午 (4 小時)**:
- [ ] 建立 Fastify 應用基礎結構
- [ ] 設定 Prisma ORM 和資料庫 Schema
- [ ] 實作基本的控制器和服務結構
- [ ] 設定 BullMQ 和 Redis 連接

**下午 (4 小時)**:
- [ ] 實作 CORS 和安全性中介軟體
- [ ] 建立錯誤處理和日誌系統
- [ ] 實作基本的 API 路由結構
- [ ] 建立健康檢查端點

**交付物**:
- [ ] 後端基礎架構完成
- [ ] 資料庫 Schema 建立
- [ ] Queue 系統配置完成

#### Day 3: 前端基礎架構
**時間**: 8 小時  
**負責人**: 前端開發者  
**風險等級**: 中

**上午 (4 小時)**:
- [ ] 建立 Next.js 專案結構
- [ ] 設定 SWR 和 API 客戶端
- [ ] 建立基本的頁面和組件結構
- [ ] 實作路由和導航

**下午 (4 小時)**:
- [ ] 建立 Admin 首頁基礎 UI
- [ ] 建立 Shopline Connector 頁面
- [ ] 實作響應式設計
- [ ] 設定環境變數和配置

**交付物**:
- [ ] 前端基礎架構完成
- [ ] 基本 UI 組件完成
- [ ] 路由和導航完成

### Phase 2: 核心功能實作 (5-6 天)

#### Day 4: 認證系統實作
**時間**: 8 小時  
**負責人**: 全體團隊  
**風險等級**: 高

**上午 (4 小時)**:
- [ ] 實作 Shopline OAuth 2.0 流程
- [ ] 建立 JWT 認證系統
- [ ] 實作 Token 儲存和刷新機制
- [ ] 建立認證中介軟體

**下午 (4 小時)**:
- [ ] 實作授權完成頁邏輯
- [ ] 建立自動導回機制
- [ ] 測試完整認證流程
- [ ] 修復認證相關問題

**交付物**:
- [ ] OAuth 2.0 流程完成
- [ ] JWT 認證系統完成
- [ ] 授權完成頁邏輯完成

#### Day 5: Shopline 服務實作
**時間**: 8 小時  
**負責人**: 後端開發者  
**風險等級**: 中

**上午 (4 小時)**:
- [ ] 實作 Shopline API 服務封裝
- [ ] 建立 REST API 和 GraphQL 支援
- [ ] 實作 Webhook 訂閱和管理
- [ ] 建立 API 測試端點

**下午 (4 小時)**:
- [ ] 實作商品管理 API
- [ ] 實作訂單管理 API
- [ ] 實作商店資訊 API
- [ ] 測試所有 Shopline API

**交付物**:
- [ ] Shopline 服務完成
- [ ] Webhook 管理完成
- [ ] API 測試端點完成

#### Day 6: Event 系統實作
**時間**: 8 小時  
**負責人**: 全體團隊  
**風險等級**: 中

**上午 (4 小時)**:
- [ ] 實作 Event 資料模型
- [ ] 建立 Event 儲存和查詢服務
- [ ] 實作 BullMQ Event Processor
- [ ] 建立 Event 發布機制

**下午 (4 小時)**:
- [ ] 實作 SSE 即時推播
- [ ] 建立 Event 監控 API
- [ ] 實作測試事件觸發
- [ ] 測試 Event 流轉機制

**交付物**:
- [ ] Event 系統完成
- [ ] 即時推播完成
- [ ] Event 監控完成

#### Day 7: 前端功能整合
**時間**: 8 小時  
**負責人**: 前端開發者  
**風險等級**: 中

**上午 (4 小時)**:
- [ ] 整合 Admin 首頁功能
- [ ] 實作 Event 監測 UI
- [ ] 建立 Connector 管理介面
- [ ] 實作即時事件更新

**下午 (4 小時)**:
- [ ] 整合 Shopline Connector 功能
- [ ] 實作 Token 管理 UI
- [ ] 建立 Webhook 管理介面
- [ ] 實作 API 測試區塊

**交付物**:
- [ ] Admin 首頁功能完成
- [ ] Shopline Connector 功能完成
- [ ] 前端功能整合完成

#### Day 8: 測試和優化
**時間**: 8 小時  
**負責人**: 全體團隊  
**風險等級**: 中

**上午 (4 小時)**:
- [ ] 執行端到端測試
- [ ] 測試所有功能流程
- [ ] 效能測試和優化
- [ ] 修復發現的問題

**下午 (4 小時)**:
- [ ] 安全性測試
- [ ] 錯誤處理測試
- [ ] UI/UX 優化
- [ ] 文件更新

**交付物**:
- [ ] 所有功能測試通過
- [ ] 效能優化完成
- [ ] 文件更新完成

### Phase 3: 整合與測試 (3-4 天)

#### Day 9: 部署準備
**時間**: 8 小時  
**負責人**: 全體團隊  
**風險等級**: 中

**上午 (4 小時)**:
- [ ] 準備生產環境配置
- [ ] 設定環境變數和密鑰
- [ ] 準備部署腳本
- [ ] 建立回滾計劃

**下午 (4 小時)**:
- [ ] 測試部署流程
- [ ] 準備監控和告警
- [ ] 更新文件
- [ ] 準備用戶通知

**交付物**:
- [ ] 部署準備完成
- [ ] 部署腳本測試通過
- [ ] 文件更新完成

#### Day 10: 生產環境部署
**時間**: 8 小時  
**負責人**: 全體團隊  
**風險等級**: 高

**上午 (4 小時)**:
- [ ] 部署後端到 Render
- [ ] 部署前端到 Vercel
- [ ] 設定域名和 SSL
- [ ] 驗證部署成功

**下午 (4 小時)**:
- [ ] 執行生產環境測試
- [ ] 監控系統狀態
- [ ] 修復發現的問題
- [ ] 確認所有功能正常

**交付物**:
- [ ] 生產環境部署完成
- [ ] 所有功能正常運作
- [ ] 系統監控正常

#### Day 11: 驗證和優化
**時間**: 8 小時  
**負責人**: 全體團隊  
**風險等級**: 低

**上午 (4 小時)**:
- [ ] 執行完整功能驗證
- [ ] 效能監控和優化
- [ ] 用戶體驗測試
- [ ] 收集用戶反饋

**下午 (4 小時)**:
- [ ] 修復發現的問題
- [ ] 優化系統效能
- [ ] 更新文件
- [ ] 準備後續維護計劃

**交付物**:
- [ ] 系統驗證完成
- [ ] 效能優化完成
- [ ] 維護計劃準備完成

#### Day 12-13: 緩衝時間和清理
**時間**: 16 小時  
**負責人**: 全體團隊  
**風險等級**: 低

**用途**:
- 處理意外問題
- 額外的測試和驗證
- 代碼清理和優化
- 文件完善
- 團隊培訓

---

## 📋 詳細檢查清單

### 準備階段檢查清單

#### 環境設定
- [ ] **開發環境**
  - [ ] Node.js 18+ 安裝
  - [ ] TypeScript 配置
  - [ ] Git 配置
  - [ ] 編輯器設定 (VS Code 推薦)
  - [ ] 必要擴展安裝

- [ ] **專案結構**
  - [ ] 建立 `frontend/` 目錄 (Next.js)
  - [ ] 建立 `backend/` 目錄 (Fastify)
  - [ ] 建立 `shared/` 目錄 (共用類型)
  - [ ] 更新 `.gitignore`
  - [ ] 建立新的 `package.json`

- [ ] **版本控制**
  - [ ] 建立新的 Git 分支
  - [ ] 設定分支保護規則
  - [ ] 建立 Pull Request 模板
  - [ ] 設定自動化檢查

#### 平台設定
- [ ] **Render 設定**
  - [ ] 建立 Render 帳戶
  - [ ] 建立 Web Service
  - [ ] 建立 PostgreSQL 資料庫
  - [ ] 設定環境變數
  - [ ] 配置自動部署

- [ ] **Vercel 設定**
  - [ ] 建立 Vercel 專案
  - [ ] 配置 Next.js 部署
  - [ ] 設定自定義域名
  - [ ] 配置環境變數
  - [ ] 設定自動部署

- [ ] **Redis Cloud 設定**
  - [ ] 建立 Redis Cloud 帳戶
  - [ ] 建立 Redis 實例
  - [ ] 配置連接設定
  - [ ] 測試連接

### 開發階段檢查清單

#### 後端開發
- [ ] **基礎架構**
  - [ ] Fastify 應用建立
  - [ ] TypeScript 配置
  - [ ] 中介軟體配置
  - [ ] 路由結構建立
  - [ ] 錯誤處理實作
  - [ ] 日誌系統實作

- [ ] **資料庫**
  - [ ] Prisma ORM 配置
  - [ ] 資料庫 Schema 設計
  - [ ] 查詢優化
  - [ ] 連接池管理
  - [ ] 備份策略
  - [ ] 監控設定

- [ ] **Queue 系統**
  - [ ] BullMQ 配置
  - [ ] Redis 連接設定
  - [ ] Worker 實作
  - [ ] 錯誤處理
  - [ ] 監控設定

- [ ] **API 端點**
  - [ ] 認證 API
  - [ ] Shopline API Proxy
  - [ ] Event API
  - [ ] Webhook API
  - [ ] 健康檢查 API

- [ ] **安全性**
  - [ ] CORS 配置
  - [ ] 速率限制
  - [ ] 輸入驗證
  - [ ] JWT 認證
  - [ ] 錯誤處理
  - [ ] 日誌記錄

#### 前端開發
- [ ] **基礎架構**
  - [ ] Next.js 專案建立
  - [ ] TypeScript 配置
  - [ ] 模組化設計
  - [ ] 狀態管理
  - [ ] 路由配置
  - [ ] 錯誤處理

- [ ] **API 整合**
  - [ ] SWR 配置
  - [ ] API 客戶端實作
  - [ ] 認證管理
  - [ ] 請求攔截器
  - [ ] 錯誤處理
  - [ ] 重試機制

- [ ] **UI 組件**
  - [ ] 響應式設計
  - [ ] 組件庫建立
  - [ ] 主題配置
  - [ ] 動畫效果
  - [ ] 無障礙支援

- [ ] **功能頁面**
  - [ ] Admin 首頁
  - [ ] Shopline Connector 頁面
  - [ ] 授權完成頁
  - [ ] Event 監測頁面
  - [ ] 設定頁面

- [ ] **使用者體驗**
  - [ ] 載入狀態
  - [ ] 錯誤提示
  - [ ] 成功反饋
  - [ ] 導航體驗
  - [ ] 效能優化

### 測試階段檢查清單

#### 單元測試
- [ ] **後端測試**
  - [ ] 控制器測試
  - [ ] 服務測試
  - [ ] 中介軟體測試
  - [ ] 工具函數測試
  - [ ] 資料庫測試

- [ ] **前端測試**
  - [ ] 組件測試
  - [ ] 工具函數測試
  - [ ] API 客戶端測試
  - [ ] 狀態管理測試
  - [ ] 路由測試

#### 整合測試
- [ ] **API 測試**
  - [ ] 認證流程測試
  - [ ] Shopline API 測試
  - [ ] Event 系統測試
  - [ ] Webhook 測試
  - [ ] 錯誤處理測試

- [ ] **端到端測試**
  - [ ] 完整用戶流程測試
  - [ ] 跨瀏覽器測試
  - [ ] 響應式測試
  - [ ] 無障礙測試
  - [ ] 效能測試

#### 部署測試
- [ ] **環境測試**
  - [ ] 開發環境測試
  - [ ] 預覽環境測試
  - [ ] 生產環境測試
  - [ ] 回滾測試
  - [ ] 監控測試

### 部署階段檢查清單

#### 部署準備
- [ ] **配置檢查**
  - [ ] 環境變數設定
  - [ ] 資料庫連接測試
  - [ ] Redis 連接測試
  - [ ] 第三方服務配置
  - [ ] 安全性設定
  - [ ] 效能配置

- [ ] **監控設定**
  - [ ] 日誌收集
  - [ ] 錯誤追蹤
  - [ ] 效能監控
  - [ ] 告警設定
  - [ ] 儀表板配置

#### 部署執行
- [ ] **後端部署**
  - [ ] Render 部署
  - [ ] 資料庫遷移
  - [ ] 環境變數設定
  - [ ] 健康檢查
  - [ ] 功能驗證

- [ ] **前端部署**
  - [ ] Vercel 部署
  - [ ] 靜態資源優化
  - [ ] CDN 配置
  - [ ] 快取設定
  - [ ] 功能驗證

#### 部署後驗證
- [ ] **功能驗證**
  - [ ] 所有 API 端點測試
  - [ ] 前端功能測試
  - [ ] 認證流程測試
  - [ ] Event 系統測試
  - [ ] 資料一致性檢查
  - [ ] 效能基準測試

- [ ] **監控驗證**
  - [ ] 日誌收集正常
  - [ ] 錯誤追蹤正常
  - [ ] 效能監控正常
  - [ ] 告警機制正常
  - [ ] 儀表板正常

---

## 🚨 風險管理

### 高風險項目
1. **認證系統**
   - 風險: 用戶無法登入或授權失敗
   - 緩解: 充分測試、回滾計劃、用戶通知

2. **Event 系統**
   - 風險: 事件丟失或處理失敗
   - 緩解: 詳細測試、監控、錯誤處理

3. **Queue 系統**
   - 風險: 任務堆積或處理失敗
   - 緩解: 監控、告警、自動重試

### 中風險項目
1. **效能問題**
   - 風險: 系統響應變慢
   - 緩解: 效能測試、監控、優化

2. **部署問題**
   - 風險: 部署失敗或回滾
   - 緩解: 自動化部署、測試環境、回滾計劃

### 低風險項目
1. **UI 調整**
   - 風險: 用戶體驗變化
   - 緩解: 用戶測試、反饋收集、快速修復

---

## 📊 成功指標

### 技術指標
- [ ] 所有測試通過率 > 95%
- [ ] API 響應時間 < 500ms
- [ ] 前端載入時間 < 2 秒
- [ ] 系統可用性 > 99.9%
- [ ] 錯誤率 < 0.1%

### 業務指標
- [ ] 零資料遺失
- [ ] 零服務中斷
- [ ] 用戶體驗無負面影響
- [ ] 開發效率提升 > 50%
- [ ] 維護成本降低 > 30%

### 品質指標
- [ ] 代碼覆蓋率 > 80%
- [ ] 文件完整度 100%
- [ ] 安全性檢查通過
- [ ] 效能基準達標
- [ ] 用戶滿意度 > 4.0/5.0

---

## 📚 技術文件

### 架構文件
- [MVP 中台架構設計](./architecture/MVP_MIDDLEWARE_ARCHITECTURE.md)
- [Fastify 後端架構](./architecture/BACKEND_ARCHITECTURE_V3.md)
- [Next.js 前端架構](./architecture/FRONTEND_ARCHITECTURE_V3.md)
- [Event 系統設計](./architecture/EVENT_SYSTEM_DESIGN.md)

### API 文件
- [後端 API 文件](./api/BACKEND_API_DOCUMENTATION.md)
- [前端 API 客戶端](./api/FRONTEND_API_CLIENT.md)
- [Webhook API 文件](./api/WEBHOOK_API_DOCUMENTATION.md)

### 部署文件
- [Render 部署指南](./deployment/RENDER_DEPLOYMENT.md)
- [Vercel 部署指南](./deployment/VERCEL_DEPLOYMENT.md)
- [環境變數配置](./deployment/ENVIRONMENT_VARIABLES.md)

---

## 📞 聯絡和支援

### 團隊角色
- **專案經理**: 負責時程管理和風險控制
- **後端開發者**: 負責 Fastify API 和 Queue 系統
- **前端開發者**: 負責 Next.js UI 和用戶體驗
- **測試工程師**: 負責測試和品質保證

### 溝通機制
- **每日站會**: 15 分鐘，同步進度和問題
- **週報**: 每週五，總結進度和下週計劃
- **緊急聯絡**: 24/7 緊急問題處理
- **文件更新**: 即時更新專案文件

### 支援資源
- **技術文件**: 完整的開發和部署指南
- **測試環境**: 獨立的測試和預覽環境
- **監控系統**: 即時系統狀態監控
- **回滾計劃**: 快速回滾到穩定版本

---

**版本**: 1.0.0  
**建立日期**: 2025-01-27  
**狀態**: 準備開始  
**下一步**: 開始 Phase 1 專案結構重組